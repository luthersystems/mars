---
# tasks file for alb-ingress-controller

- name: Helm chart exists
  synchronize:
    src: alb-ingress-controller/
    dest: "{{alb_ingress_controller_helm_chart_path}}"
    delete: yes
    recursive: yes
    owner: no
    group: no
    use_ssh_args: yes

- name: Install the alb-ingress-controller
  command:
    argv:
      - helm
      - upgrade
      - --install
      - --namespace=kube-system
      - --set=clusterName={{kubectl_eks_cluster_name}}
      - --set=image.tag={{alb_ingress_controller_tag}}
      - ingress-controller
      - "{{alb_ingress_controller_helm_chart_path}}"
  environment:
    AWS_ACCESS_KEY_ID: "{{kubectl_aws_access_key_id}}"
    AWS_SECRET_ACCESS_KEY: "{{kubectl_aws_secret_access_key}}"
    AWS_SESSION_TOKEN: "{{kubectl_aws_session_token}}"
    KUBECONFIG: "{{kubectl_config_path}}"
