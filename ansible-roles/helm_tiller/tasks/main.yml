---
# tasks file for helm_tiller

- name: K8s resource definitions exist
  synchronize:
    src: tiller/
    dest: "{{helm_tiller_k8s_resource_path}}"
    recursive: yes
    owner: no
    group: no
    use_ssh_args: yes

- name: K8s resources exist
  k8s: 
    src: "{{helm_tiller_k8s_resource_path}}/{{item}}"
  with_items:
    - "{{helm_tiller_k8s_resources}}"
  environment:
    AWS_ACCESS_KEY_ID: "{{kubectl_aws_access_key_id}}"
    AWS_SECRET_ACCESS_KEY: "{{kubectl_aws_secret_access_key}}"
    AWS_SESSION_TOKEN: "{{kubectl_aws_session_token}}"
    KUBECONFIG: "{{kubectl_config_path}}"

- name: Initialize tiller
  command:
    argv:
      - helm
      - init
      - --service-account
      - "{{helm_tiller_service_account}}"
      - --history-max={{helm_tiller_history_max}}
      - --wait
      - --upgrade
      - --tiller-connection-timeout=100
      - --override=spec.template.spec.containers[0].command={{helm_tiller_command}}
  environment:
    AWS_ACCESS_KEY_ID: "{{kubectl_aws_access_key_id}}"
    AWS_SECRET_ACCESS_KEY: "{{kubectl_aws_secret_access_key}}"
    AWS_SESSION_TOKEN: "{{kubectl_aws_session_token}}"
    KUBECONFIG: "{{kubectl_config_path}}"
